<div class="container">
  <div class="search-container">
    <input 
      type="text" 
      [(ngModel)]="terminoBusqueda" 
      (input)="buscar()"
      placeholder="Buscar en todos los campos..."
      class="search-input">
  </div>

  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>Dispositivo</th>
          <th>Raza</th>
          <th>Cruza</th>
          <th>Sexo</th>
          <th>Edad (meses)</th>
          <th>Edad (días)</th>
          <th>Propietario</th>
          <th>Nombre Propietario</th>
          <th>Ubicación</th>
          <th>Tenedor</th>
          <th>Status de vida</th>
          <th>Status de trazabilidad</th>
          <th>Errores</th>
          <th>Fecha identificación</th>
          <th>Fecha registro</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let animal of animalesFiltrados" 
            (contextmenu)="onContextMenu($event, animal)"
            [class.selected]="animal === selectedAnimal">
          <td [innerHTML]="animal.dispositivo | highlight:terminoBusqueda"></td>
          <td [innerHTML]="animal.raza | highlight:terminoBusqueda"></td>
          <td [innerHTML]="animal.cruza | highlight:terminoBusqueda"></td>
          <td [innerHTML]="animal.sexo | highlight:terminoBusqueda"></td>
          <td [innerHTML]="animal.edadMeses.toString() | highlight:terminoBusqueda"></td>
          <td [innerHTML]="animal.edadDias.toString() | highlight:terminoBusqueda"></td>
          <td [innerHTML]="animal.propietario | highlight:terminoBusqueda"></td>
          <td class="nombre-propietario">
            <ng-container *ngIf="!editingName[animal.propietario]">
              <span class="nombre-display" (click)="editarNombre(animal)" [innerHTML]="(animal.nombrePropietario || 'Click para agregar nombre') | highlight:terminoBusqueda">
              </span>
            </ng-container>
            <ng-container *ngIf="editingName[animal.propietario]">
              <div class="nombre-edit">
                <input 
                  type="text" 
                  [value]="animal.nombrePropietario"
                  #nombreInput
                  (keyup.enter)="guardarNombre(animal, nombreInput.value)"
                  (keyup.escape)="cancelarEdicion(animal.propietario)">
                <div class="edit-buttons">
                  <button (click)="guardarNombre(animal, nombreInput.value)" class="save-btn">
                    <i class="fas fa-check"></i>
                  </button>
                  <button (click)="cancelarEdicion(animal.propietario)" class="cancel-btn">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </ng-container>
          </td>
          <td [innerHTML]="animal.ubicacion | highlight:terminoBusqueda"></td>
          <td [innerHTML]="animal.tenedor | highlight:terminoBusqueda"></td>
          <td [innerHTML]="animal.statusVida | highlight:terminoBusqueda"></td>
          <td [innerHTML]="animal.statusTrazabilidad | highlight:terminoBusqueda"></td>
          <td [innerHTML]="animal.errores | highlight:terminoBusqueda"></td>
          <td [innerHTML]="animal.fechaIdentificacion | highlight:terminoBusqueda"></td>
          <td [innerHTML]="animal.fechaRegistro | highlight:terminoBusqueda"></td>
        </tr>
        <tr *ngIf="animalesFiltrados.length === 0">
          <td colspan="15" class="empty-message">
            No hay datos disponibles. Arrastra un archivo Excel para cargar información.
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="drop-overlay" *ngIf="isDragging">
    <div class="drop-zone">
      <div class="drop-message">
        <i class="fas fa-file-excel"></i>
        <h2>Suelta el archivo Excel aquí</h2>
      </div>
    </div>
  </div>

  <div class="context-menu" *ngIf="showContextMenu" [style.top.px]="contextMenuY" [style.left.px]="contextMenuX">
    <div class="menu-item" (click)="mostrarInputNuevaLista()">
      <i class="fas fa-plus"></i>
      <span>Nueva lista</span>
    </div>
    <div class="new-list-input" *ngIf="showNewListInput">
      <input 
        type="text" 
        [(ngModel)]="newListName" 
        placeholder="Nombre de la lista"
        (keyup.enter)="crearNuevaLista()"
        #newListInput>
      <div class="input-buttons">
        <button (click)="crearNuevaLista()" class="save-btn" [disabled]="!newListName.trim()">
          <i class="fas fa-check"></i>
        </button>
        <button (click)="showNewListInput = false" class="cancel-btn">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="menu-separator" *ngIf="listas.length > 0"></div>
    <div class="menu-item" *ngFor="let lista of listas" (click)="agregarYMostrarLista(lista)">
      <i class="fas fa-list"></i>
      <span>Agregar a {{ lista.nombre }}</span>
    </div>
    <div class="menu-separator"></div>
    <div class="menu-item" (click)="exportarExcel()">
      <i class="fas fa-file-excel"></i>
      <span>Exportar Excel</span>
    </div>
  </div>

  <div *ngIf="showNewListInput" class="new-list-input" [style.left.px]="contextMenuPosition.x" [style.top.px]="contextMenuPosition.y">
    <input 
      type="text" 
      [(ngModel)]="newListName" 
      placeholder="Nombre de la lista"
      (keyup.enter)="crearNuevaLista()"
      #newListInput>
    <div class="input-buttons">
      <button (click)="crearNuevaLista()" class="save-btn">
        <i class="fas fa-check"></i>
      </button>
      <button (click)="showNewListInput = false" class="cancel-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showListDetails" (click)="closeListDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ listaSeleccionada?.nombre }}</h2>
        <div class="modal-actions">
          <button class="export-btn" (click)="exportarListaExcel()">
            <i class="fas fa-file-excel"></i>
            Exportar Excel
          </button>
          <button class="close-btn" (click)="closeListDetails()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="modal-body">
        <div class="list-info">
          <p class="list-date">Creada: {{ listaSeleccionada?.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}</p>
          <p class="list-date">Última modificación: {{ listaSeleccionada?.ultimaModificacion | date:'dd/MM/yyyy HH:mm' }}</p>
        </div>
        <div class="list-content">
          <div *ngFor="let propietario of getPropietariosLista()" class="propietario-item">
            <div class="propietario-header">
              <h3>{{ propietario.nombre }}</h3>
              <span class="propietario-numero">({{ propietario.numero }})</span>
            </div>
            <div class="animales-list">
              <div *ngFor="let dispositivo of propietario.animales" class="animal-item">
                {{ dispositivo }}
              </div>
            </div>
          </div>
          <div *ngIf="getPropietariosLista().length === 0" class="empty-list">
            No hay propietarios en esta lista
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Diálogo de confirmación -->
  <div class="confirm-dialog" *ngIf="showConfirmDialog" [style.left.px]="confirmDialogPosition.x" [style.top.px]="confirmDialogPosition.y">
    <div class="confirm-content">
      <p>{{ confirmDialogMessage }}</p>
      <div class="confirm-actions">
        <button class="confirm-btn" (click)="confirmAction()">
          <i class="fas fa-check"></i>
          Confirmar
        </button>
        <button class="cancel-btn" (click)="cancelConfirmation()">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div> 